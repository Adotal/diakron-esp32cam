#include "service_ui.h"
#include "display_driver.h"
#include "button_driver.h"
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// Variables internas
static bool uiEnabled = true;
static UIState currentState = UI_MENU;
static uint8_t selectedIndex = 0;

MenuItem menuItems[] = {
    {"Sensores", UI_VIEW_SENSORS},
    {"Niveles", UI_VIEW_LEVELS},
    {"Test Camara", UI_CAMERA_TEST},
    {"WiFi Status", UI_WIFI_STATUS}
};

const uint8_t menuLength = sizeof(menuItems) / sizeof(MenuItem);

// Configure OLED
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// Logo
const unsigned char logo[] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0xff, 0xc1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xf3, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0x80, 0x00, 0x7f, 0x80, 0x01, 0xff, 0x80, 0x00, 0x7f, 0xff, 
	0xff, 0x80, 0x00, 0x7f, 0x80, 0x00, 0xff, 0x00, 0x01, 0xff, 0xff, 0xff, 0x80, 0x00, 0x7f, 0x80, 
	0x00, 0xff, 0x00, 0x03, 0xff, 0xff, 0xff, 0x80, 0x00, 0x7f, 0x80, 0x01, 0xff, 0x00, 0x07, 0xff, 
	0x7f, 0xff, 0x80, 0x00, 0x7f, 0x80, 0x03, 0xff, 0x00, 0x07, 0xff, 0x3f, 0xff, 0x80, 0x00, 0x7f, 
	0x80, 0x07, 0xfe, 0x00, 0x07, 0xff, 0x0f, 0xff, 0x83, 0x00, 0x7f, 0x80, 0x0f, 0xfe, 0x00, 0x07, 
	0xff, 0x03, 0xff, 0x87, 0xc0, 0x7f, 0x80, 0x1f, 0xec, 0x00, 0x07, 0xff, 0x01, 0xff, 0x0f, 0xf0, 
	0x7f, 0x80, 0x3f, 0xc4, 0x00, 0x07, 0xff, 0x01, 0xfc, 0x0f, 0xf8, 0x7f, 0x80, 0x3f, 0x80, 0x00, 
	0x07, 0xff, 0x01, 0xe0, 0x1f, 0xfc, 0x7f, 0x80, 0x7f, 0x00, 0x00, 0x07, 0xff, 0x03, 0x00, 0x3f, 
	0xff, 0x7f, 0x80, 0xfe, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x3f, 0xff, 0xff, 0x81, 0xfc, 0x00, 
	0x00, 0x07, 0xff, 0x00, 0x00, 0x7f, 0xff, 0xff, 0x83, 0xf8, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 
	0x7f, 0xff, 0xff, 0x87, 0xf0, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x3f, 0xff, 0xff, 0x8f, 0xe0, 
	0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x0f, 0xff, 0xff, 0x9f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0xff, 0xff, 0xbf, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x3f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xf8, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x20, 0x3f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x01, 
	0xfe, 0x00, 0x00, 0x30, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x03, 0xff, 0x80, 0x00, 0x33, 0xff, 
	0xff, 0xfe, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xc0, 0x00, 0x3f, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 
	0x1f, 0xff, 0xe0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x7f, 
	0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x3f, 0xff, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xe0, 0x00, 
	0x00, 0x07, 0xff, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xe7, 0xf0, 0x00, 0x00, 0x03, 0xff, 0x00, 0x00, 
	0x7f, 0xff, 0xff, 0xc3, 0xf8, 0x00, 0x00, 0x03, 0xff, 0x00, 0x38, 0x7f, 0xff, 0x7f, 0x81, 0xfc, 
	0x00, 0x00, 0x03, 0xff, 0x00, 0xf8, 0x7f, 0xfe, 0x7f, 0x80, 0xfe, 0x00, 0x00, 0x03, 0xff, 0x01, 
	0xfc, 0x7f, 0xf8, 0x7f, 0x80, 0x7f, 0x00, 0x00, 0x03, 0xff, 0x07, 0xfc, 0x7f, 0xe0, 0x7f, 0x80, 
	0x3f, 0x80, 0x00, 0x03, 0xff, 0x1f, 0xfe, 0x1f, 0xc0, 0x7f, 0x80, 0x1f, 0xc0, 0x00, 0x03, 0xff, 
	0xff, 0xfe, 0x03, 0xe0, 0x7f, 0x80, 0x0f, 0xe3, 0x00, 0x03, 0xff, 0xff, 0xff, 0x00, 0xe0, 0x7f, 
	0x80, 0x07, 0xf3, 0x00, 0x01, 0xff, 0xff, 0xff, 0x80, 0x30, 0x7f, 0x80, 0x03, 0xff, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0x80, 0x00, 0x7f, 0x80, 0x01, 0xff, 0x00, 0x00, 0x3f, 0xff, 0xff, 0x80, 0x00, 
	0x7f, 0x80, 0x00, 0xff, 0x80, 0x00, 0x1f, 0xff, 0xff, 0x00, 0x00, 0x7f, 0x80, 0x00, 0x7f, 0x80, 
	0x00, 0x07, 0xff, 0xfc, 0x00, 0x00, 0x7f, 0x80, 0x00, 0x3f, 0x80, 0x00, 0x01, 0xff, 0xf0, 0x00, 
	0x00, 0x7f, 0x80, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x7f, 0x80, 0x00, 0x7f, 
	0xc0, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x00, 0xff, 0xc0
};


void drawMenu()
{
    display.clearDisplay();
    display.setTextSize(1);

    for (uint8_t i = 0; i < menuLength; i++)
    {
        int y = i * 12;

        if (i == selectedIndex)
        {
            display.fillRect(0, y, 128, 12, SSD1306_WHITE);
            display.setTextColor(SSD1306_BLACK);
        }
        else
        {
            display.setTextColor(SSD1306_WHITE);
        }

        display.setCursor(5, y + 2);
        display.print(menuItems[i].label);
    }

    display.display();
}


void drawSensors()
{
    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0,0);
    // TESTING, replace with real sensor values
    display.println("IND: OK");
    display.println("CAP: OK");
    display.println("AI: metal");

    display.display();
}

void service_ui_update()
{
    if (!uiEnabled) return;
    handleButton();

    switch (currentState)
    {
        case UI_MENU:
            drawMenu();
            break;

        case UI_VIEW_SENSORS:
            drawSensors();
            break;

        case UI_VIEW_LEVELS:
            // drawLevels();
            break;

        case UI_CAMERA_TEST:
            // drawCameraTest();
            break;

        case UI_WIFI_STATUS:
            // drawWifi();
            break;
    }
}

void ui_nextItem()
{
    if (currentState == UI_MENU)
    {
        selectedIndex++;
        if (selectedIndex >= menuLength)
            selectedIndex = 0;
    }
}

void ui_select()
{
    if (currentState == UI_MENU)
        currentState = menuItems[selectedIndex].targetState;
    else
        currentState = UI_MENU;
}

UIState ui_getState()
{
    return currentState;
}



bool service_ui_init()
{
    pinMode(SERVICE_BUTTON_PIN, INPUT_PULLUP);

    if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDR))
    {
        //Serial.println("OLED init failed");
        return false;
    }

    display.clearDisplay();
    display.display();
    display.drawBitmap( (display.width() - LOGO_WIDTH ) / 2,((display.height()- LOGO_HEIGHT) / 2 ), logo, LOGO_WIDTH, LOGO_HEIGHT, WHITE);
    display.display();
    return true;
}


void service_ui_enable(bool enable)
{
    uiEnabled = enable;
}

bool service_ui_isActive()
{
    return uiEnabled;
}







